<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">
  <title>OFCS Professional Reimbursement Form</title>
  <style>
    #formContainer {
      padding-bottom: 40px;
    }
    #header0 {
      padding-top: 2vw;
    }
    #header1 {
      font-size:3.5vw;
      font-weight: bold;
    }
    #header2 {
      font-size:2.5vw;
    }
    img {
      vertical-align: middle;
    }
    .row .col{
      padding: 0px !important;
      margin-bottom: 0px !important;
      margin-top: 0px !important;
    }
    .grey {
      padding: 5px 10px 10px 10px;
    }

  </style>
</head>
<body>
  <header class="header indigo darken-3 white-text">
    <div class="container">
      <div class="row">
        <div class="col s12">
          <img src="https://ofhsmath.com/online_forms/images/banner.png" alt="" class="responsive-img">
        </div>
      </div>
    </div>
  </header>
  <div class="container" id="formContainer">
    <div class="col s12">
        <form id="formValidate" novalidate="novalidate">
          <div class="row">
            <div class="input-field col s12 m6">
              <i class="material-icons prefix">date_range</i>
              <input type="text" name="subNum" id="subNum" value="<?= info[0] ?>" readonly>
              <label for="subNum">Submission ID</label>
            </div>
            <div class="input-field col s12 m6">
              <i class="material-icons prefix"></i>
              <input type="text" name="timeSTamp" id="timeStamp" value="<?= info[2] ?>" readonly>
              <label for="timeStamp">Submission Date</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12 m6">
              <i class="material-icons prefix">person</i>
              <input type="text" name="lastName" id="lastName" value="<?= info[3] ?>" readonly>
              <label for="lastName">Last Name</label>
            </div>
            <div class="input-field col s12 m6">
              <i class="material-icons prefix"></i>
              <input type="text" name="firstName" id="firstName" value="<?= info[4] ?>" readonly>
              <label for="firstName">First Name</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12 m6">
              <i class="material-icons prefix">business</i>
              <input type="text" id="building" name="building" value="<?= info[5] ?>" readonly>
              <label for="building">Assignment/Job Title</label>
            </div>
            <div class="input-field col s12 m6">
              <i class="material-icons prefix"></i>
              <input type="text" id="assignment" name="assignment" value="<?= info[6] ?>" readonly>
              <label for="assignment">Assignment/Job Title</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12 m6">
              <i class="material-icons prefix">email</i>
              <input type="email" id="email" name="email" value="<?= info[7] ?>" readonly>
              <label for="email">Your Email</label>
            </div>
            <div class="input-field col s12 m6">
              <i class="material-icons prefix">phone</i>
              <input type="text" id="phone" name="phone" value="<?= info[8] ?>" readonly>
              <label for="phone">Phone Extension</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12">
              <i class="material-icons prefix">info</i>
              <input type="text" id="meetingInfo" name="meetingInfo" value="<?= info[9] ?>" readonly>
              <label for="meetingInfo">Name/Type of Meeting</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12 m6">
              <i class="material-icons prefix"></i>
              <input type="text" id="dates" name="dates" value="<?= info[10] ?>" readonly>
              <label for="dates">Meeting Date(s)</label>
            </div>
            <div class="input-field col s12 m6">
              <i class="material-icons prefix"></i>
              <input type="text" id="location" name="location" value="<?= info[11] ?>" readonly>
              <label for="location">Location</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12 m6">
              <i class="material-icons prefix">announcement</i>
              <input type="text" id="subNeed" name="subNeed" value="<?= info[12] ?>" readonly>
              <label for="subNeed">Substitute Needed</label>
            </div>
            <div class="input-field col s12 m6">
              <i class="material-icons prefix"></i>
              <input type="text" id="subDays" name="subDays" value="<?= info[13] ?>" readonly>
              <label for="subDays">Days Substitute Needed</label>
            </div>
          </div>
          <div class="grey lighten-3" id="costs">
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <h5>Estimated Costs</h5>
              </div>
              <div class="input-field col s4 offset-s2">
                <h5>Actual Costs</h5>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="text" id="mileageTotal" name="mileageTotal" value="<?= info[15] ?>" readonly>
                <label for="mileageTotal">Estimated Total Mileage</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="number" id="actMileageTotal" name="actMileageTotal" >
                <label for="actMileageTotal">Actual Total Mileage</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="text" id="registrationTotal" name="registrationTotal" value="<?= info[17] ?>" readonly>
                <label for="registrationTotal">Estimated Registration</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="number" id="actRegistrationTotal" name="actRegistrationTotal">
                <label for="actRegistrationTotal">Actual Registration</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="text" id="parkingTotal" name="parkingTotal" value="<?= info[18] ?>" readonly>
                <label for="parkingTotal">Estimated Parking/Tolls</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="number" id="actParkingTotal" name="actParkingTotal">
                <label for="actParkingTotal">Actual Parking/Tolls</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="text" id="lodgingTotal" name="lodgingTotal" value="<?= info[21] ?>" readonly>
                <label for="lodgingTotal">Estimated Lodging</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="number" id="actLodgingTotal" name="actLodgingTotal">
                <label for="actLodgingTotal">Actual Lodging</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="text" id="breakfastTotal" name="breakfastTotal" value="<?= info[23] ?>" readonly>
                <label for="breakfastTotal">Estimated Breakfast</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="number" id="actBreakfastTotal" name="actBreakfastTotal">
                <label for="actBreakfastTotal">Actual Breakfast</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="text" id="lunchTotal" name="lunchTotal" value="<?= info[25] ?>" readonly>
                <label for="lunchTotal">Estimated Lunch</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="number" id="actLunchTotal" name="actLunchTotal">
                <label for="actLunchTotal">Actual Lunch</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="text" id="dinnerTotal" name="dinnerTotal" value="<?= info[27] ?>" readonly>
                <label for="dinnerTotal">Estimated Dinner</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="number" id="actDinnerTotal" name="actDinnerTotal">
                <label for="actDinnerTotal">Actual Dinner</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="text" id="grandTotal" name="grandTotal" value="<?= info[28] ?>" readonly>
                <label for="grandTotal">Estimated Total Cost</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="text" id="actGrandTotal" name="actGrandTotal" placeholder="$0.00" disabled>
                <label for="actGrandTotal">Actual Total Cost</label>
              </div>
            </div>
          </div>
          <br>
          <div class="row">
            <div class="input-field col s12 m6">
              <i class="material-icons prefix">edit</i>
              <input type="text" id="signature" name="signature" value="<?= info[29] ?>" readonly>
              <label for="signature">Digital Signature</label>
            </div>
            <div class="input-field col s12 m6">
              <i class="material-icons prefix"></i>
              <input type="text" id="signDate" name="signDate" value="<?= info[30] ?>" readonly>
              <label for="signDate">Date</label>
            </div>
          </div>
          <div class="row" style="margin-bottom: 0px;">
            <div class="input-field col s12">
              <i class="material-icons prefix">comment</i>
              <textarea id="finalComments" name="finalComments" class="materialize-textarea" readonly><?= info[36] ?></textarea>
              <label for="finalComments">Final Submission Comments.</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12">
              <i class="material-icons prefix">info</i>
              <input type="text" id="uploadLink" name="uploadLink" value="http://www.ofcs.net" readonly>
              <label for="uploadLink">Link to Receipts:</label>
            </div>
          </div>
          <div id="output"></div>
          <div class="row" style="margin-bottom: 0px;">
            <div class="input-field col s12 center-align">
              <!-- onclick="submitForm(); return false;" -->
              <button class="waves-effect waves-light btn green submit-btn" id="btnApprove" type="submit">Approve
                <i class="material-icons right">check</i>
              </button>
              <button class="waves-effect waves-light btn red submit-btn" id="btnReject" type="submit">Reject
                <i class="material-icons right">clear</i>
              </button>
            </div>
          </div>
        </form>
      </div>
  </div>
  
  <!-- Compiled and minified JavaScript -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>
  <script>
      var numUploads = {};
      numUploads.done = 0;
      numUploads.total = 0;

      // Upload the files into a folder in drive
      // This is set to send them all to one folder (specificed in the .gs file)
      function uploadFiles() {
        var allFiles = document.getElementById('myFiles').files;
		var lName = document.getElementById('lastName').value;
		var nDate = document.getElementById('dateOfActivity').value;
        var fixedDate = nDate.replace(/\,/g,"");
        console.log(fixedDate);
		var folderName = lName + ' '+ fixedDate + ' EAP Verification';
        
		if (allFiles.length == 0) {
		  window.alert('No file selected!');
		} else {
		  numUploads.total = allFiles.length;
		  google.script.run.withSuccessHandler(function(r) {
            // send files after the folder is created...
			for (var i = 0; i < allFiles.length; i++) {
			  // Send each file at a time
			  uploadFile(allFiles[i], r.folderId);
			}
          }).createFolder(folderName);
        }
      }
      function uploadFile(file, folderId) {
        var reader = new FileReader();
		reader.onload = function(e) {
		  var content = reader.result;
		  document.getElementById('output').innerHTML = 'uploading ' + file.name + '...';			
		  google.script.run.withSuccessHandler(onFileUploaded)
		    .uploadFile(content, file.name, folderId);
		}
		reader.readAsDataURL(file);
      }
      function onFileUploaded(r) {
        numUploads.done++;
		document.getElementById('output').innerHTML = 'uploaded '
		  + r.fileName + ' (' + numUploads.done + '/'
		  + numUploads.total + ' files).';
		if (numUploads.done == numUploads.total) {
		  document.getElementById('output').innerHTML = 'Upload complete. '
            + numUploads.total + ' file(s) uploaded. ';
		  numUploads.done = 0;
          const form = document.getElementsByClassName('main')[0];
          const data = formToJSON(form.elements);
          console.log(data);
      
          var dataToSend = JSON.stringify(data, null, "  ");
          
          google.script.run
            .withSuccessHandler (onSuccess)
            .withFailureHandler (onFailure)
            .withUserObject(this)
            .submitReport2(dataToSend);
		}
      }
      
function approve() {
        document.getElementById('btnApprove').disabled=true;
        document.getElementById('btnReject').disabled=true;
        
        var data = {
            "subNum": <?= info[0] ?>,
            "timeStamp": <?= info[2] ?>,
            "firstName": <?= info[4] ?>,
            "lastName": <?= info[3] ?>,
            "email": <?= info[7] ?>,
            "meetinginfo": <?= info[9] ?>,
            "dates": <?= info[10] ?>,
            "grandtotal": <?= info[28] ?>,
        };
        var myJSON = JSON.stringify(data);
        
        google.script.run
            .withSuccessHandler (onSuccess)
            .withFailureHandler (onFailure)
            .withUserObject(this)
            .approveSubmission3(myJSON);
    }
        
    function reject() {
        document.getElementById('btnApprove').disabled=true;
        document.getElementById('btnReject').disabled=true;
        
        var data = {
            "subNum": <?= info[0] ?>,
            "timeStamp": <?= info[2] ?>,
            "firstName": <?= info[4] ?>,
            "lastName": <?= info[3] ?>,
            "email": <?= info[7] ?>,
            "meetinginfo": <?= info[9] ?>,
            "dates": <?= info[10] ?>,
            "grandtotal": <?= info[28] ?>,         
        };
        var myJSON = JSON.stringify(data);
        
        google.script.run
            .withSuccessHandler (onSuccess)
            .withFailureHandler (onFailure)
            .withUserObject(this)
            .rejectSubmission3(myJSON);
    }
        
    function onSuccess() {
        var div = document.getElementById('output');
        div.innerHTML = 'Form submission completed.';
    }
    function onFailure() {
        var div = document.getElementById('output');
        div.innerHTML = 'Something went wrong with final submission form!';
    }
    
    const formToJSON = (elements) => [].reduce.call(elements, (data, element) => {
      // Make sure the element has the required properties.
      console.log(element.value);
      if (isValidElement(element) && isValidValue(element)) {
        if (isCheckbox(element)) {
          data[element.name] = (data[element.name] || []).concat(element.value);
        } else {
          data[element.name] = element.value;
        }
      }

      return data;
    }, {});
    const isValidElement = element => {
      return element.name;
    };
    const isValidValue = element => {
      return (!['checkbox', 'radio'].includes(element.type) || element.checked);
    };
    const isCheckbox = element => element.type === 'checkbox';
    const isSelect = element => element.type === 'select';
    const getSelectValues = options => [].reduce.call(options, (values, option) => {
      return option.selected ? values.concat(option.value) : values;
    }, []);

    $(document).ready(function(){
      $('#btnApprove').click(approve);
      $('#btnReject').click(reject);
    });
    
  </script>
</body>
</html>




