<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">
  <title>OFCS Professional Reimbursement Form</title>
  <style>
    #formContainer {
      padding-bottom: 40px;
    }
    #header0 {
      padding-top: 2vw;
    }
    #header1 {
      font-size:3.5vw;
      font-weight: bold;
    }
    #header2 {
      font-size:2.5vw;
    }
    img {
      vertical-align: middle;
    }
    .row .col{
      padding: 0px !important;
      margin-bottom: 0px !important;
      margin-top: 0px !important;
    }
    .grey {
      padding: 5px 10px 10px 10px;
    }
    #subDays {
      margin-top: -15px;
    }
    #subDay {
      margin-top: -10px;
    }
  </style>
</head>
<body>
  <header class="header indigo darken-3 white-text">
    <div class="container">
      <div class="row">
        <div class="col s12">
          <img src="https://ofhsmath.com/online_forms/images/banner.png" alt="" class="responsive-img">
        </div>
      </div>
    </div>
  </header>
  <div class="container" id="formContainer">
    <div class="col s12">
        <form id="formValidate" novalidate="novalidate">
          <div class="row">
            <div class="input-field col s12 m6">
              <i class="material-icons prefix">person</i>
              <input type="text" name="lastName" id="lastName" required>
              <label for="lastName">Last Name</label>
            </div>
            <div class="input-field col s12 m6">
              <i class="material-icons prefix"></i>
              <input type="text" name="firstName" id="firstName" required>
              <label for="firstName">First Name</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12 m6">
              <i class="material-icons prefix">business</i>
              <select id="building" name="building">
                <option value="" disabled selected>Choose your option</option>
                <option value="HS">High School</option>
                <option value="MS">Middle School</option>
                <option value="OFIS">Intermediate School</option>
                <option value="FL">Falls-Lenox</option>
                <option value="ECC">Early Childhood Center</option>
              </select>
              <label>Building</label>
            </div>
            <div class="input-field col s12 m6">
              <i class="material-icons prefix"></i>
              <input type="text" id="assignment" name="assignment">
              <label for="assignment">Assignment/Job Title</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12 m6">
              <i class="material-icons prefix">email</i>
              <input type="email" id="email" name="email">
              <label for="email">Your Email</label>
            </div>
            <div class="input-field col s12 m6">
              <i class="material-icons prefix">phone</i>
              <input type="text" id="phone" name="phone">
              <label for="phone">Phone Extension</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12">
              <i class="material-icons prefix">info</i>
              <input type="text" id="meetingInfo" name="meetingInfo">
              <label for="meetingInfo">Name/Type of Meeting</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12 m6">
              <i class="material-icons prefix"></i>
              <input type="text" id="dates" name="dates">
              <label for="dates">Meeting Date(s)</label>
            </div>
            <div class="input-field col s12 m6">
              <i class="material-icons prefix"></i>
              <input type="text" id="location" name="location" required>
              <label for="location">Location</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field">
              <i class="material-icons prefix"></i>
              <div class="col s12 m3 offset-s1">
                <span>Substitute Needed</span>
              </div>
              <div class="col s2 offset-s1">
                <label>
                  <input type="radio" value="No" name="subNeed" checked>
                  <span>No</span>
                </label>
              </div>  
              <div class="col s2 offset-s1">
                <label>
                  <input type="radio" value="Yes" name="subNeed">
                  <span>Yes</span>
                </label>
              </div>
              <div class="input-field col s2 subInput">
                <input type="number" id="subDays" step="0.1" name="subDays">
                <label for="subDays" id="subDay"># Days</label>
              </div> 
            </div>
          </div>
          <div class="grey lighten-3" id="costs">
            <h5>Estimated Costs</h5>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="number" id="mileage" name="mileage">
                <label for="mileage">Total Mileage</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="text" id="mileageTotal" name="mileageTotal" placeholder="$0.00" disabled>
                <label for="mileageTotal">Mileage</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="number" id="registration" name="registration" step="0.01">
                <label for="registration">Registration</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="text" id="registrationTotal" name="registrationTotal" placeholder="$0.00" disabled>
                <label for="registrationTotal">Registration</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="number" id="parking" name="parking" step="0.01">
                <label for="parking">Parking/Tolls</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="text" id="parkingTotal" name="parkingTotal" placeholder="$0.00" disabled>
                <label for="parkingTotal">Parking/Tolls</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="number" id="lodging" name="lodging" step="0.01">
                <label for="lodging">Lodging</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="text" id="lodgingTotal" name="lodgingTotal" placeholder="$0.00" disabled>
                <label for="lodgingTotal">Lodging</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="number" id="breakfast" name="breakfast" step="0.01">
                <label for="breakfast">Breakfast</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="text" id="breakfastTotal" name="breakfastTotal" placeholder="$0.00" disabled>
                <label for="breakfastTotal">Breakfast</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="number" id="lunch" name="lunch" step="0.01">
                <label for="lunch">Lunch</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="text" id="lunchTotal" name="lunchTotal" placeholder="$0.00" disabled>
                <label for="lunchTotal">Lunch</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s1">
                <input type="number" id="dinner" name="dinner" step="0.01">
                <label for="dinner">Dinner</label>
              </div>
              <div class="input-field col s4 offset-s2">
                <input type="text" id="dinnerTotal" name="dinnerTotal" placeholder="$0.00" disabled>
                <label for="dinnerTotal">Dinner</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s4 offset-s7">
                <input type="text" id="grandTotal" name="grandTotal" placeholder="$0.00" disabled>
                <label for="grandTotal">Total Cost</label>
              </div>
            </div>
          </div>
          <br>
          <div class="row">
            <div class="input-field col s12 m6">
              <i class="material-icons prefix">edit</i>
              <input type="text" id="signature" name="signature">
              <label for="signature">Digital Signature</label>
            </div>
            <div class="input-field col s12 m6">
              <i class="material-icons prefix"></i>
              <input type="text" class="datepicker" id="signDate" name="signDate" required>
              <label for="signDate">Date</label>
            </div>
          </div>
          <div id="output"></div>
          <div class="row" id="myButton">
            <div class="input-field center">
              <button class="indigo waves-effect waves-light btn submit-btn" id="btnSubmit" type="submit">Submit
                <i class="material-icons right">send</i>
              </button>
          </div>
          </div>
        </form>
      </div>
  </div>
  
  <!-- Compiled and minified JavaScript -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>
  <script>
    function submitForm(e) {   
      document.getElementById('btnSubmit').disabled=true;
      const form = document.getElementById('formValidate');
      //console.log(form.elements);
      const data = formToJSON(form.elements);
      console.log(data);
    
      var dataToSend = JSON.stringify(data, null, "  ");
        
      google.script.run
        .withSuccessHandler (onSuccess)
        .withFailureHandler (onFailure)
        .withUserObject(this)
        .submitReport(dataToSend);
    }
    function onSuccess() {
      var div = document.getElementById('output');
      div.innerHTML = 'Form submission completed.';
    }
    function onFailure() {
      var div = document.getElementById('output');
      div.innerHTML = 'Something went wrong!';
    }
    const formToJSON = (elements) => [].reduce.call(elements, (data, element) => {
      // Make sure the element has the required properties.
      console.log(element.value);
      if (isValidElement(element) && isValidValue(element)) {
        if (isCheckbox(element)) {
          data[element.name] = (data[element.name] || []).concat(element.value);
        } else {
          data[element.name] = element.value;
        }
      }

      return data;
    }, {});
    const isValidElement = element => {
      return element.name;
    };
    const isValidValue = element => {
      return (!['checkbox', 'radio'].includes(element.type) || element.checked);
    };
    const isCheckbox = element => element.type === 'checkbox';
    const isSelect = element => element.type === 'select';
    const getSelectValues = options => [].reduce.call(options, (values, option) => {
      return option.selected ? values.concat(option.value) : values;
    }, []);

    $(document).ready(function(){
      $('select').formSelect();
      $('.datepicker').datepicker();
      var element = document.querySelector('.datepicker');
      M.Datepicker.getInstance(element).setDate(new Date(), true);
      
      $.validator.setDefaults({
          highlight: function(element, errorClass, validClass) {
            if (element.tagName === 'SELECT')
              $(element).closest('.select-wrapper').addClass('invalid');
            else
              $(element).removeClass(validClass).addClass(errorClass);
          },
          unhighlight: function(element, errorClass, validClass) {
            if (element.tagName === 'SELECT')
              $(element).closest('.select-wrapper').removeClass('invalid');
            else
              $(element).removeClass(errorClass).addClass(validClass);
          },
          errorClass: 'invalid',
          validClass: "valid",
          
        });
      $("#formValidate").validate({
        errorPlacement: function (error, element) {
          $(element)
            .closest("form")
            .find("label[for='" + element.attr("id") + "']")
            .attr('data-error', error.text());
        },
        rules: {
          'email': {
            required: true,
            email: true
          },
          'firstName': "required",
          'lastName': "required",
          'location': "required",
          'signDate': {
            required: true,
            date: true
          },
        },
        messages: {
          'email': {
            required: "Please enter the referring staff member's email.",
            email: "Please enter a valid email for the referring staff member."
          },
          'firstName': "Please enter student's first name.",
          'lastName': "Please enter student's last name",
          'location': "Please select a location.",
          'signDate': {
            required: "Please click to choose date.",
            date: "Please enter a valid date."
          },
        },
        submitHandler: function(form, event) { 
          event.preventDefault();
          submitForm(event);
        }
      });
    });
    
    $("input[id='mileage']").on("change", function(){
      calculateCosts();
    });
    $("input[id='registration']").on("change", function(){
      calculateCosts();
    });
    $("input[id='parking']").on("change", function(){
      calculateCosts();
    });
    $("input[id='lodging']").on("change", function(){
      calculateCosts();
    });
    $("input[id='breakfast']").on("change", function(){
      calculateCosts();
    });
    $("input[id='lunch']").on("change", function(){
      calculateCosts();
    });
    $("input[id='dinner']").on("change", function(){
      calculateCosts();
    });
    function calculateCosts() {
      var mileageCost = Number($('#mileage').val());
      var registrationCost = Number($('#registration').val());
      var parkingCost = Number($('#parking').val());
      var lodgingCost = Number($('#lodging').val());
      var breakfastCost = Number($('#breakfast').val());
      var lunchCost = Number($('#lunch').val());
      var dinnerCost = Number($('#dinner').val());
      document.getElementById('mileageTotal').value = "$" + (mileageCost * 0.58).toFixed(2);
      document.getElementById('registrationTotal').value = "$" + registrationCost.toFixed(2);
      document.getElementById('parkingTotal').value = "$" + parkingCost.toFixed(2);
      document.getElementById('lodgingTotal').value = "$" + lodgingCost.toFixed(2);
      document.getElementById('breakfastTotal').value = "$" + breakfastCost.toFixed(2);
      document.getElementById('lunchTotal').value = "$" + lunchCost.toFixed(2);
      document.getElementById('dinnerTotal').value = "$" + dinnerCost.toFixed(2);
      document.getElementById('grandTotal').value = "$" + (mileageCost * 0.58 + registrationCost + 
        parkingCost + lodgingCost + breakfastCost + lunchCost + dinnerCost).toFixed(2);
    }
  </script>
</body>
</html>